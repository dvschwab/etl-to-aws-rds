# Establishing IAM Role-Based Authentication for AWS-hosted Databases

Amazon Web Services (AWS) provides the Relational Database Service (RDS) to procure MySQL and other SQL databases. The RDS service handles typical administrative tasks such as backups and updates, while users interact with the database itself. Together, this natural division of responsibility offloads the time-consuming administrative work to Amazon while providing users with a fully-functional database instance accessible with their preexisting skill set.

Since the database is fully integrated into the AWS ecosystem, other AWS services can provide additional functionality. Here, we describe how the Identity and Access Management (IAM) service can provide an additional layer of role-based security to control database access. This layer operates separately from standard database security controls such as login/passwords, permissions, and SSL. The benefits are both increased security and additional offloading of access management to AWS.

## Overview

While configuring role-based authentication is not difficult, it does require several steps. Some of these are performed via AWS (either through the Console or the AWS CLI), while others take place in the database proper. There are also preliminary requirements that must be met before role-based security may be procured.

Here is the list of required steps:

#### Preliminary
1. Establish database connectivity
2. Secure connection with SSL

#### Role-Based Security
1. Enable IAM authentication for database
2. Create policy allowing database access
3. Create IAM user and attach access policy
4. Create database user identified by AWS Authentication
5. Generate authentication token
6. Connect to database with IAM user and token

### Preliminary Steps

Before using role-based authentication, you must be able to connect to the database using standard protocols. In MySQL, this can be done with the MySQL client using the following syntax:

`mysql -h <hostname> -p <port> -u <user> -p <password>`

Here, the *hostname* can be found on the AWS Console at **RDS > Databases > <database-name> > Connectivity & Security**: it will follow the pattern *database-name.unique-id.region.rds.amazonaws.com*. The *user* and *password* are the credentials generated by `CREATE USER`. The *port* may be omitted if the default port 3306 is used. Note that it is more secure to omit the password itself and just add the *-p* option: this invokes a separate password validation script that masks the password as it is entered, preventing it from appearing in the command history.

To secure the connection with SSL, first download the AWS global certification bundle; as of this writing, the bundle is located at https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem. Save this in a convenient location and reference it with additional client options:

`mysql -h <hostname> -p <port> -u <user> -p <password> --ssl-mode=VERIFY_CA --ssl-ca=<certificate path>`

Here, the *VERIFY_CA* option forces the client to verify the AWS certificates with the registered Certificate Authority; without this option, the connection will still be encrypted, but there is no guarantee the certificates themselves have not been compromised. Note that you do not need to generate a key pair for the client machine, as there is no way to modify the RDS instance to use it.

#### Sidebar

After verifying connectivity, you can use the *mysql_config* tool to save the connection parameters as a profile; afterwards, you just need to supply the profile name (and any additional parameters). You can also specify the SSL options in the global configuration file (typically named *my.ini* or *my.conf*) instead of typing them.

### Role-Based Security

Once connectivity has been established and SSL configured, you can begin the process of enabling role-based security. The steps to do so are listed below.

#### 1. Enable IAM Authentication

The first step is to enable IAM Authentication for the database. You can do this by selecting the database from the RDS Console and then selecting **Modify**. Be sure to enable the change to be applied immediately; otherwise, it won't be applied until the next maintenance window. It typically takes a few minutes to apply the change; you can verify that IAM Authentication is enabled on the **RDS > Databases > <database-name> > Configuration** screen.

#### 2. Create IAM Policy Governing Database Access

After IAM Authentication is enabled, the next step is to create an IAM Policy to govern database access. To do this, go to the IAM Console and select **Policies > Create Policy**. Then, select *RDS IAM Authentication* from the list of services (NOT the *RDS* service itself; that refers to RDS governance, not database access). 

Next, configure **Actions** to *Permissions management* and *connect*. This provides the policy grantee the ability to connect to the database, but no additional permissions. This is what you want for the typical user: database-level permissions, such as SELECT, INSERT, etc. will still control what the user can do for a given database, while the IAM Authentication provides an additional secureity layer for database access. If desired, the *Manual actions* setting allows you to grant RDS permissions other than simply *connect*: note, however, that these permissions refer to the RDS instance, NOT the database itself. You should only enable these additional permissions if the user is expected to perform RDS actions such as creating or modifying an RDS instance.

After setting user **Actions**, select the **Resources** arrow to specify the particular RDS instance the policy governs. This will bring up a dialogue box: you will need to specify the RDS *Region*, the *Account* where it was created, the *Resource ID*, and the *User Name* of the user to have access. The Region and Account number can be found on the AWS Console; the Resource ID is just the name of the RDS instance, and the user name is the user who will have access.

Finally, you can optionally set certain *Request conditions*, such as requiring Multi-Factor Authentication (MFA) or restricting access to a specific IP range. Neither is necessary, but may be configured to further enhance database security.

#### 3. Attach IAM Policy to a User

Once the policy governing database access is made, you need to attach it to an AWS user. This can be a new user you create or an existing user: the only condition is that the user must also have a valid login to the database itself with the same user name. In other words, if you create a new AWS user named *iam_user*, you will also need (in the next step) to create a user named *iam_user* in the database itself (i.e. using `CREATE USER`).

After the user has been selected, attach the database access policy to it. This can be done at the IAM Console by selecting the access policy under **Policies** followed by **Actions > Attach**. You can filter by user name if needed.

#### 4. Create a Database Account for Policy User

The above steps will attach the IAM policy to an AWS user; however, it is also necessary to have a database user with the same account name. For a new user, use `CREATE USER` with the following syntax:

```SQL
CREATE USER <username> IDENTIFIED BY AWSAuthenticationPlugin as 'RDS'
```

Here, instead of specifying a password, the `IDENTIFIED BY` parameter is set to *AWSAuthenticationPlugin*, which the MySQL identification module used for IAM connections. If you want to use an existing user, substitute the syntax for `ALTER USER`; note that this will invalidate that user's password, so they won't be able to connect to the database until their IAM access is fully configured.

#### 5. Connecting to the Database as an IAM User

The last step in configuring an IAM connection is to actually connect to the database. This is a two-step process involving the AWS CLI and the MySQL client: the CLI is used to generate a security token that is then passed to the client in lieu of a password (note that you can also connect using the AWS SDK or a library such as Python's *boto3*; the steps involved are similar).

To generate the authentication token, use the following syntax for the AWS CLI:

```Linux
aws rds generate-db-auth-token \
	--hostname <hostname> \
	--port 3306 \
	--region <region> \
	--username <user>
```
(in this example, the `\` character is only to continue the statement across line breaks; it may be omitted if desired).

Substitute your database instance parameters for the *hostname*, *region*, and *user*; the port may be omitted if it the default 3306. The *user* must exist in the AWS account and have the IAM policy attached allowing access to the database.

This will return a very long string that serves as the user's password from the mySQL client. The official documentation, accessible at `docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.AWSCLI.html`, provides the following example of the first part of a token:

```
rdsmysql.123456789012.us-west-2.rds.amazonaws.com:3306/?Action=connect&DBUser=jane_doe&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Expires=900...
```

(here, the trailing three dots have the usual meaning of MORE TO FOLLOW, and are not part of the token)

Since the authentication token may be several hundred characters, Amazon recommends saving it as an environmental variable. In Linux, you can use the `set` command to do this; for example:

```Linux
set TOKEN = "$(aws rds generate-db-auth-token <parameters>)"
```

This syntax runs the shell command specified between the parentheses and saves the output as the environmental variable TOKEN. You can then access the variable as $TOKEN in the following call to the MySQL client:

```Linux
mysql --host=<hostname> --port=3306 --ssl-ca=<path/to/CA> --enable-cleartext-plugin --user=<user> --password=$TOKEN
```

As can be seen, the only additional syntax is the parameter `--password=$TOKEN` and the option `--enable-cleartext-plugin`. The latter is necessary for the client to submit the password (i.e. $TOKEN) without encryption (you'll still see a warning, however). While normally this would be a security risk, the token itself does not provide any information that an attacker could use to defeat the security.

After submitting the MySQL syntax, and assuming all goes as intended, you will be connected to the database with both SSL and IAM role-based security. You can verify the SSL part by entering `status` at the mysql prompt.



