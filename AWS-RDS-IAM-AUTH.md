# Establishing IAM Role-Based Authentication for AWS-Hosted Databases

Amazon Web Services (AWS) provides the Relational Database Service (RDS) to procure MySQL and other SQL databases. The RDS service handles typical administrative tasks such as backups and updates, while users interact with the database itself. Together, this natural division of responsibility offloads the time-consuming administrative work to Amazon while providing users with a fully-functional database instance accessible with their preexisting skill set.

Since the database is fully integrated into the AWS ecosystem, other AWS services can provide additional functionality. Here, we describe how the Identity and Access Management (IAM) service can provide an additional layer of role-based security to control database access. This layer operates separately from standard database security controls such as login/passwords, permissions, and SSL. The benefits are both increased security and additional offloading of access management to AWS.

## Overview

While configuring role-based authentication is not difficult, it does require several steps. Some of these are performed via AWS (either through the Console or the AWS CLI), while others take place in the database proper. There are also preliminary requirements that must be met before role-based security may be procured.

Here is the list of required steps:

#### Preliminary
1. Establish database connectivity
2. Secure connection with SSL

#### Role-Based Security
1. Enable IAM authentication for database
2. Create policy allowing database access
3. Create IAM user and attach access policy
4. Create database user identified by AWS Authentication
5. Generate authentication token
6. Connect to database with IAM user and token

### Preliminary Steps

Before using role-based authentication, you must be able to connect to the database using standard protocols. In MySQL, this can be done with the MySQL client using the following syntax:

`mysql -h <hostname> -p <port> -u <user> -p <password>`

Here, the *hostname* can be found on the AWS Console at **RDS > Databases > <database-name> > Connectivity & Security**: it will follow the pattern *database-name.unique-id.region.rds.amazonaws.com*. The *user* and *password* are the credentials generated by `CREATE USER`. The *port* may be omitted if the default port 3306 is used. Note that it is more secure to omit the password itself and just add the *-p* option: this invokes a separate password validation script that masks the password as it is entered, preventing it from appearing in the command history.

To secure the connection with SSL, first download the [AWS global certificate bundle](https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem). Save this in a convenient location and reference it with additional client options:

`mysql -h <hostname> -p <port> -u <user> -p <password> --ssl-mode=VERIFY_CA --ssl-ca=<certificate path>`

Here, the *VERIFY_CA* option forces the client to verify the AWS certificates with the registered Certificate Authority; without this option, the connection will still be encrypted, but there is no guarantee the certificates themselves have not been compromised. Note that you do not need to generate a key pair for the client machine, as there is no way to modify the RDS instance to use it.

#### Sidebar

After verifying connectivity, you can use the *mysql_config* tool to save the connection parameters as a profile; afterwards, you just need to supply the profile name (and any additional parameters). You can also specify the SSL options in the global configuration file (typically named *my.ini* or *my.conf*) instead of typing them.

### Role-Based Security

Once connectivity has been established and SSL configured, you can begin the process of enabling role-based security. The steps to do so are listed below.

#### 1. Enable IAM Authentication

The first step is to enable IAM Authentication for the database. You can do this by selecting the database from the RDS Console and then selecting **Modify**. This will take you to the RDS configuration page; once there, scroll down to the section named **Database Authentication** and select the *Password and IAM Authentication* option. From there, scroll to the bottom of the screen and click *Continue*. Be sure to enable the change to be applied immediately; otherwise, it won't be applied until the next maintenance window. It typically takes a few minutes to apply the change; you can verify that IAM Authentication is enabled on the **RDS > Databases > database-name > Configuration** screen.

#### 2. Create IAM Policy Governing Database Access

After IAM Authentication is enabled, the next step is to create an IAM Policy to govern database access. To do this, go to the IAM Console and select **Policies > Create Policy**. Then, select *RDS IAM Authentication* from the list of services (NOT the *RDS* service itself; that refers to RDS governance, not database access). 

Next, configure **Actions** to *Permissions management* and *connect*. Only the *Permissions management* is visible at first; you can select the arrow to see the *connect* check box, although if you select *Permissions management* it will be selected as well. This provides the policy grantee the ability to connect to the database, but no additional permissions. This is what you want for the typical user: database-level permissions, such as `SELECT`, `INSERT`, etc. will still control what the user can do for a given database, while the IAM Authentication provides an additional security layer for database access.

After setting user **Actions**, select the **Resources** arrow to specify the particular RDS instance the policy governs. Unfortunately, this part of the user interface is not intuitive and just plain difficult. First, select the *specific* option with the radio button to create a policy for a specific RDS database. Next, click the (very small) link reading "Add ARN". This will bring up a dialogue box: you will need to specify the RDS *Region*, the *Account* where it was created, the *Resource ID*, and the *User Name* of the user to have access. If you don't know the region, you can find it on the RDS database configuration page for that instance. The Account number should be populated automatically: if not, it is just the AWS account where the RDS instance was created. The oddly-named Resource ID is the name of the database. The User Name is the name of the user who will have access. This is the user you will attach this policy to in the next step.

Finally, you can optionally set certain *Request conditions*, such as requiring Multi-Factor Authentication (MFA) or restricting access to a specific IP range. Neither is necessary, but may be configured to further enhance database security.

#### 3. Attach IAM Policy to a User

Once the policy governing database access is made, you need to attach it to an AWS user. This can be a new user you create or an existing user: the only condition is that the user must also have a valid login to the database itself with the same user name. In other words, if you create a new AWS user named *iam_user*, you will also need (in the next step) to create a user named *iam_user* in the database itself (i.e. using `CREATE USER`).

After the user has been selected, attach the database access policy to it. This can be done at the IAM Console by selecting the access policy under **Policies** followed by **Actions > Attach**. You can filter by user name if needed.

#### 4. Create a Database Account for Policy User

The above steps will attach the IAM policy to an AWS user; however, it is also necessary to have a database user with the same account name. For a new user, use `CREATE USER` with the following syntax:

```SQL
CREATE USER <username> IDENTIFIED BY AWSAuthenticationPlugin as 'RDS'
```

Here, instead of specifying a password, the `IDENTIFIED BY` parameter is set to *AWSAuthenticationPlugin*, which the MySQL identification module used for IAM connections. If you want to use an existing user, substitute the syntax for `ALTER USER`; note that this will invalidate that user's password, so they won't be able to connect to the database until their IAM access is fully configured.

#### 5. Generate the Authentication Token

The last step in configuring an IAM connection is to actually connect to the database. This is a two-step process involving the AWS CLI and the MySQL client: the CLI is used to generate a security token that is then passed to the client in lieu of a password.

We will describe how to generate the token first. To generate the authentication token, use the following syntax for the AWS CLI:

```Linux
aws rds generate-db-auth-token \
	--hostname <hostname> \
	--port 3306 \
	--region <region> \
	--username <user>
```

Substitute your database instance parameters for the *hostname*, *region*, and *user*; the port may be omitted if it the default 3306. The *user* must exist in the AWS account and have the IAM policy attached allowing access to the database.

This will return a very long string that serves as the user's password from the mySQL client; the AWS documentation provides a [sample token](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.AWSCLI.html) that is reproduced here:

```
rdsmysql.123456789012.us-west-2.rds.amazonaws.com:3306/?Action=connect&DBUser=jane_doe&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Expires=900...
```

(here, the trailing three dots have the usual meaning of MORE TO FOLLOW, and are not part of the token)

Since the authentication token may be several hundred characters, Amazon recommends saving it as an environmental variable, like so: 

```Linux
TOKEN="$(aws rds generate-db-auth-token <parameters>)"
```

Be sure that there is no space between the variable name and the value. The expression inside the parenthesis will be executed, and the result returned and stored as the value of TOKEN. Note that you must specify the port, even if it is the default.

#### 6. Connect to the MySQL Database with the Authentication Token
	
This syntax runs the shell command specified between the parentheses and saves the output as the environmental variable TOKEN. You can then access the variable as $TOKEN in the following call to the MySQL client:

```Linux
mysql --host=<hostname> --port=3306 --ssl-mode=VERIFY_CA --ssl-ca=<path/to/CA> --enable-cleartext-plugin --user=<user> --password=$TOKEN
```

As can be seen, the only additional syntax is the parameter `--password=$TOKEN` and the option `--enable-cleartext-plugin`. The latter is necessary for the client to submit the password (i.e. $TOKEN) without encryption (you'll still see a warning, however). While normally this would be a security risk, the token itself does not provide any information that an attacker could use to defeat the security.

After submitting the MySQL syntax, and assuming all goes as intended, you will be connected to the database with both SSL and IAM role-based security. You can verify the SSL part by entering `status` at the mysql prompt.

If you receive an error, double-check that the token has been generated. Remember that when setting a bash environmental variable there can be no space between the variable and the value (e.g. TOKEN="abc", not TOKEN= "abc"). Also remember that you need to use the `$` prefix to use the variable after it is set. Also, be sure the port is included, even if it is the default. If you receive an error about SSL, be sure you have provided the exact path to the certificate bundle.

To simplify the process, you can use a shell script to retrieve the token and connect to the database: here is an [example script](https://github.com/dvschwab/etl-to-aws-rds/blob/1a3b0cdf651c6505cce6c4d57ab86306a242c0e1/conn-mysql-iam-auth.sh).



